rules_version = '2';
service cloud.firestore {
  match /databases/{database}/documents {

    // Hilfsfunktion: Prüft, ob der Nutzer eingeloggt ist
    function isAuthenticated() {
      return request.auth != null;
    }

    // Prüft, ob Nutzer Besitzer ist
    function isOwner(rsc) {
      return isAuthenticated() && request.auth.uid == rsc.data.ownerId;
    }

    // Prüft, ob Nutzer Mitglied ist
    function isMember(rsc) {
      return isAuthenticated() && (request.auth.uid in rsc.data.members);
    }

    // Prüft, ob Nutzer eingeladen ist (ausstehend)
    function isPendingMember(rsc) {
      return isAuthenticated() && (request.auth.uid in rsc.data.get('pending_members', []));
    }

    // --- Users Collection (Profile) ---
    match /users/{userId} {
      allow read: if isAuthenticated();
      allow create, update, delete: if isAuthenticated() && request.auth.uid == userId;
    }

    // --- Shopping Lists Collection ---
    match /shopping_lists/{listId} {
      // Lesen: Erlaubt für Mitglieder und Eingeladene
      allow read: if isMember(resource) || isPendingMember(resource);

      // Erstellen: OwnerId muss UID sein, UID muss in members sein
      allow create: if isAuthenticated()
                    && request.resource.data.ownerId == request.auth.uid
                    && request.auth.uid in request.resource.data.members;

      // Aktualisieren: 
      // 1. Besitzer/Mitglieder dürfen alles (Name ändern, etc.)
      // 2. Eingeladene dürfen NUR ihren Status ändern (beitreten/ablehnen)
      allow update: if isMember(resource) 
                    || (isPendingMember(resource) 
                        && request.resource.data.diff(resource.data).affectedKeys().hasOnly(['members', 'pending_members']));

      // Löschen: NUR der Besitzer darf die Liste löschen
      allow delete: if isOwner(resource);

      // --- Unter-Sammlung "items" ---
      match /items/{itemId} {
        // Zugriff nur für echte Mitglieder (nicht für ausstehende)
        allow read, write: if isAuthenticated()
                           && request.auth.uid in get(/databases/$(database)/documents/shopping_lists/$(listId)).data.members;
      }
    }
  }
}