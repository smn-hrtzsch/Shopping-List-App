name: Manual Release Build

on:
  workflow_dispatch:
    inputs:
      release_type:
        description: "Type of release"
        required: true
        default: "patch"
        type: choice
        options:
          - patch
          - minor
          - major
      release_title:
        description: "Release Title (optional)"
        required: false
        type: string

jobs:
  bump-version:
    runs-on: ubuntu-latest
    permissions:
      contents: write
    outputs:
      new_version: ${{ steps.bump_version.outputs.new_version }}

    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Set up Python
        uses: actions/setup-python@v4
        with:
          python-version: '3.x'

      - name: Bump Version
        id: bump_version
        run: |
          python3 scripts/bump_version.py "${{ inputs.release_type }}"

      - name: Commit Version Bump & Tag
        run: |
          git config --global user.name 'GitHub Actions'
          git config --global user.email 'actions@github.com'
          git add app/build.gradle.kts
          git commit -m "Bump version to ${{ steps.bump_version.outputs.new_version }}"
          git tag "v${{ steps.bump_version.outputs.new_version }}"
          git push origin main
          git push origin "v${{ steps.bump_version.outputs.new_version }}"

  call-build-android:
    needs: bump-version
    uses: ./.github/workflows/build-android.yml
    with:
      version: ${{ needs.bump-version.outputs.new_version }}
    secrets: inherit
    permissions:
      contents: read

  publish-release:
    needs:
      [bump-version, call-build-android]
    runs-on: ubuntu-latest
    permissions:
      contents: write
    steps:
      - name: Download Android Artifacts
        uses: actions/download-artifact@v4
        with:
          name: android-artifacts
          path: release-assets

      - name: Create Release
        uses: softprops/action-gh-release@v1
        with:
          tag_name: v${{ needs.bump-version.outputs.new_version }}
          name: ${{ inputs.release_title != '' && inputs.release_title || format('Release v{0}', needs.bump-version.outputs.new_version) }}
          files: release-assets/*
          generate_release_notes: true
          draft: false
          prerelease: false
