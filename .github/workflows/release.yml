name: Manual Release Build

on:
  workflow_dispatch:
    inputs:
      release_type:
        description: "Type of release"
        required: true
        default: "patch"
        type: choice
        options:
          - patch
          - minor
          - major
      release_title:
        description: "Release Title (optional)"
        required: false
        type: string

jobs:
  bump-version:
    runs-on: ubuntu-latest
    permissions:
      contents: write
    outputs:
      new_version: ${{ steps.bump_version.outputs.new_version }}

    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Set up Python
        uses: actions/setup-python@v4
        with:
          python-version: '3.x'

      - name: Bump Version
        id: bump_version
        run: |
          python3 -c '
          import re
          import os
          import sys

          file_path = "app/build.gradle.kts"
          release_type = "${{ inputs.release_type }}"

          with open(file_path, "r") as f:
              content = f.read()

          # 1. Update Version Name
          # Pattern to find the version string: ... ?: "2.0"
          name_pattern = r'(versionName\s*=\s*project\.findProperty\("versionName"\)\s*as\s*String\?\s*\?:\s*")([^"]+)(")'
          
          match_name = re.search(name_pattern, content)
          if not match_name:
              print("Error: Could not find version name pattern.")
              sys.exit(1)

          full_match_name = match_name.group(0)
          current_version = match_name.group(2)
          
          print(f"Current Version: {current_version}")

          parts = [int(x) for x in current_version.split(".")]
          if len(parts) < 3:
              parts.extend([0] * (3 - len(parts)))
          
          if release_type == "major":
              parts[0] += 1
              parts[1] = 0
              parts[2] = 0
          elif release_type == "minor":
              parts[1] += 1
              parts[2] = 0
          else: # patch
              parts[2] += 1
          
          new_version = ".".join(map(str, parts))
          print(f"New Version: {new_version}")
          
          # Replace just the version part in the found string
          new_line_name = match_name.group(1) + new_version + match_name.group(3)
          content = content.replace(full_match_name, new_line_name)

          # 2. Update Version Code
          # Pattern to find the code: ... ?: 2
          code_pattern = r'(versionCode\s*=\s*project\.findProperty\("versionCode"\)\?\.toString\(\)\?\.toInt\(\)\s*\?:\s*)(\d+)'
          
          match_code = re.search(code_pattern, content)
          if match_code:
              full_match_code = match_code.group(0)
              current_code = int(match_code.group(2))
              new_code = current_code + 1
              print(f"Bumping versionCode from {current_code} to {new_code}")
              
              new_line_code = match_code.group(1) + str(new_code)
              content = content.replace(full_match_code, new_line_code)
          else:
              print("Warning: Could not find version code pattern. Skipping code bump.")

          with open(file_path, "w") as f:
              f.write(content)

          # Set output
          with open(os.environ["GITHUB_OUTPUT"], "a") as f:
              f.write(f"new_version={new_version}\n")
          '

      - name: Commit Version Bump & Tag
        run: |
          git config --global user.name 'GitHub Actions'
          git config --global user.email 'actions@github.com'
          git add app/build.gradle.kts
          git commit -m "Bump version to ${{ steps.bump_version.outputs.new_version }}"
          git tag "v${{ steps.bump_version.outputs.new_version }}"
          git push origin main
          git push origin "v${{ steps.bump_version.outputs.new_version }}"

  call-build-android:
    needs: bump-version
    uses: ./.github/workflows/build-android.yml
    with:
      version: ${{ needs.bump-version.outputs.new_version }}
    secrets: inherit
    permissions:
      contents: read

  publish-release:
    needs:
      [bump-version, call-build-android]
    runs-on: ubuntu-latest
    permissions:
      contents: write
    steps:
      - name: Download Android Artifacts
        uses: actions/download-artifact@v4
        with:
          name: android-apk
          path: release-assets

      - name: Create Release
        uses: softprops/action-gh-release@v1
        with:
          tag_name: v${{ needs.bump-version.outputs.new_version }}
          name: ${{ inputs.release_title != '' && inputs.release_title || format('Release v{0}', needs.bump-version.outputs.new_version) }}
          files: release-assets/*
          generate_release_notes: true
          draft: false
          prerelease: false
